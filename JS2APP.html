<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>JS2APP</title>
    <style>
        input{
            color: red;
            font-size: 18px;
            padding: 10px;
            margin: 4px;
        }
    </style>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?41cc1334afa3eded19a39d7628ed3a01";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
<input id="share" type="button" value="share">
<input id="setShareContent" type="button" value="setShareContent">
<input id="setShareContent2" type="button" value="setShareContent(指定渠道）">
<input id="storgeQRcode" type="button" value="storgeQRcode(链接方式)保存图片到本地">
<input id="storgeQRcode2" type="button" value="storgeQRcode2保存图片到本地">
<input id="getLyfCode" type="button" value="getLyfCode(来伊份授权登录)">
<IMG  id="imgtest" src="https://yun.duiba.com.cn/DS-tech/lb_tech/WechatIMG341.jpeg">
<!--<input id="storgeQRcode2" type="button" value="storgeQRcode(图片方式)">-->

<script type="text/javascript">

    document.getElementById('share').onclick= function () {
        var message = {
            'function': 'share',
            'param': {
                'url': 'https://m.laiyifen.com/group/detail.html?patchGrouponId=3000000000000126&mpId=1009090701000015&shareCode=f4ec31471fce4765a45ab9f53c2b311a',
                'title': '【拼团】巴旦木酥饼（原味）220g',
                'description': '巴旦木酥饼（原味）220g',
                'url160x160': 'https://static2.laiyifen.com/files/product/image/1553657709810_3777.jpg',
                'pic': 'https://static2.laiyifen.com/files/product/image/1553657709810_3777.jpg',
                'isMiniProgram': true,
                'originalId': 'gh_4a4a36db4c12',
                'miniProgramPage': '/pages/detail/index?id=3000000000000126&mpId=1009090701000015'
            },
            'callback': 'callresult',
            "shareSelectItem": "shareSelectItem"
        };
        appMessage(message);
    }
    document.getElementById('setShareContent').onclick= function () {
        var setShareContent = {
            "function": "setShareContent",
            "param": {
                "url": "http://m.laiyifen.com/ouser-center/duiba/autoLogin.do",
                "title": "积分当钱花，零食0元购",
                "description": "积分兑好物，各种优惠券、零食，生活服务、精选商品等你来兑换",
                "url160x160": "https://yun.duiba.com.cn/DS-tech/lb_tech/WechatIMG341.jpeg",
                "pic": "https://yun.duiba.com.cn/DS-tech/lb_tech/WechatIMG341.jpeg"
            },
            "callback": "callresult",
            "shareSelectItem": "shareSelectItem"
        }
        appMessage(setShareContent);
    }
    document.getElementById('setShareContent2').onclick= function () {
        var setShareContent2 = {
            "function": "setShareContent",
            "param": {
                "url": "https://m.laiyifen.com/goods/offlineStore/detail?storeCode=1904&storeName=%E4%B8%8A%E6%B5%B7%E5%B8%82%E9%97%B5%E8%A1%8C%E5%8C%BA%E5%8F%A4%E7%BE%8E%E8%A5%BF%E8%B7%AF%E4%B8%89%E5%BA%97",
                "title": "上海市闵行区古美西路三店",
                "description": "嘿，我发现了一家很好吃的零食店，分享给你，快去看看有什么优惠吧～",
                "posterUrl": "https://m.laiyifen.com/goods/offlineStore/poster?storeName=%E4%B8%8A%E6%B5%B7%E5%B8%82%E9%97%B5%E8%A1%8C%E5%8C%BA%E5%8F%A4%E7%BE%8E%E8%A5%BF%E8%B7%AF%E4%B8%89%E5%BA%97&storeAddress=%E9%97%B5%E8%A1%8C%E5%8C%BA%E5%8F%A4%E7%BE%8E%E8%A5%BF%E8%B7%AF260%E5%8F%B7%E7%AC%AC1%E5%B9%A2-6%E5%AE%A4&storeCode=1904",
                "channel": ["IM", "Poster", "WechatMoments", "Wechat", "QQ", "QZone"],
                "sharePicUrl": "https://static.laiyifen.com/goods-static/images/offlineShare.png"
            },
            "callback": "callresult",
            "shareSelectItem": "shareSelectItem"
        }
        appMessage(setShareContent2);
    }
    document.getElementById('storgeQRcode').onclick= function () {
        getUrlBase64('https://yun.duiba.com.cn/DS-tech/lb_tech/WechatIMG341.jpeg', 'jpg', function (base64) {
            console.log(base64);//base64编码值
            var storgeQRcode = {
                "function": "storgeQRcode", "param": {
                    "imgUrl": base64 ,
                },
                "callback": "callresult",
            "shareSelectItem": "shareSelectItem"
            }
            appMessage(storgeQRcode);
        });
    }

    document.getElementById('storgeQRcode2').onclick= function () {
        var ext= getImageBase64(document.getElementById('imgtest'), 'jpg' );
        var storgeQRcode = {
            "function": "storgeQRcode", "param": {
                "imgUrl":  ext,
            },
            "callback": "callresult",
            "shareSelectItem": "shareSelectItem"
        }
        appMessage(storgeQRcode);
    }

    document.getElementById('getLyfCode').onclick= function () {
        var getLyfCode = {
            "function": "getLyfCode",
            "param": {
                //appid
                "appid": "123456789qwer2345",
            },
            //结果回调，{"code":"1","data":"lyfcode"}
            // code==1 成功返回，code ==2 用户拒绝, code==-1 非法appid
            "callback": "callresult",
            "shareSelectItem": "shareSelectItem"

        }
        appMessage(getLyfCode);
    }


    function callresult(result) {
        alert('结果：'+result);
    }

    function shareSelectItem(result) {
        alert('渠道：'+result);
    }

    /**
     *
     * @param img html的img标签
     * @param ext 图片格式
     * @returns {string}
     */
    function getImageBase64(img, ext) {
        var canvas = document.createElement("canvas");   //创建canvas DOM元素，并设置其宽高和图片一样
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height); //使用画布画图
        var dataURL = canvas.toDataURL("image/" + ext);  //返回的是一串Base64编码的URL并指定格式
        canvas = null; //释放
        return dataURL;
    }

    /**
     *
     * @param url 图片路径
     * @param ext 图片格式
     * @param callback 结果回调
     */
    function getUrlBase64(url, ext, callback) {
        var canvas = document.createElement("canvas");   //创建canvas DOM元素
        var ctx = canvas.getContext("2d");
        var img = new Image;
        img.crossOrigin = 'Anonymous';
        img.src = url;
        img.onload = function () {
            canvas.height = 392; //指定画板的高度,自定义
            canvas.width = 363; //指定画板的宽度，自定义
            ctx.drawImage(img, 0, 0, 363, 392); //参数可自定义
            var dataURL = canvas.toDataURL("image/" + ext);
            callback.call(this, dataURL); //回掉函数获取Base64编码
            canvas = null;
        };
    }

    function appMessage(obj) {
        var u = navigator.userAgent;
        var isAndroid = u.indexOf('android') > -1 || u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //android终端或者uc浏览器
        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        if (isAndroid) {
            console.log(JSON.stringify(obj));
            str = String(JSON.stringify(obj));
            //android用的是对象转json转String   mobileAPI为原生注册的  addJavascriptInterface(javaToH5Api, "mobileAPI");
            window.mobileAPI.postMessage(str);
        } else if (isiOS) {
            //ios的用的是对象
            window.webkit.messageHandlers.mobileAPI.postMessage(obj);
        }
    };
</script>
</body>
</html>